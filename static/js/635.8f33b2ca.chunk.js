"use strict";(self.webpackChunkhk_independent_bus_eta=self.webpackChunkhk_independent_bus_eta||[]).push([[635],{3310:function(t,e,n){var r=n(7313),a=n(7829),o=n(1113),c=n(4511),i=n(6060),s=n(9878),u=n(421),l=n(6417);e.Z=function(t){var e=t.routeId,n=t.seq,d=t.containerSx,p=t.showStopName,f=void 0!==p&&p,g=(0,c.$)(),m=g.t,x=g.i18n,h=(0,r.useContext)(i.Z),v=h.db,b=v.routeList,k=v.stopList,j=h.etaFormat,Z=(0,s.e)("".concat(e,"/").concat(n));if(null==Z)return(0,l.jsx)(a.Z,{sx:d,children:(0,l.jsx)(u.u,{})});var w=function(t){if(!t)return"";var e=Math.round((new Date(t).getTime()-(new Date).getTime())/60/1e3);if(!Number.isInteger(e))return t.remark[x.language];var n=t.substr(11,5),r=e<1?"- ".concat(m("\u5206\u9418")):"".concat(e," ").concat(m("\u5206\u9418"));switch(j){case"exact":return n;case"diff":return r;default:return"".concat(n," (").concat(r,")")}},C=Object.values(b[e].stops)[0][n];return(0,l.jsxs)(a.Z,{sx:d,children:[f?(0,l.jsx)(o.Z,{variant:"caption",children:k[C].name[x.language]}):null,0===Z.length?m("\u672a\u6709\u73ed\u6b21\u8cc7\u6599"):Z.map((function(t,e){return(0,l.jsxs)(o.Z,{variant:"subtitle1",children:[w(t.eta)," -"," ",t.remark[x.language]?t.remark[x.language]:""," ",m(t.co)]},"route-".concat(e))}))]})}},1635:function(t,e,n){n.r(e),n.d(e,{default:function(){return ft}});var r,a=n(1413),o=n(9439),c=n(3433),i=n(7313),s=n(501),u=n(7829),l=n(1113),d=n(9536),p=n(6060),f=n(5640),g=n(4511),m=n(4165),x=n(5861),h=n(936),v=n.n(h),b=n(587),k=n(7592),j=n(8151),Z=n(6417),w=function(){var t=(0,x.Z)((0,m.Z)().mark((function t(e,n){var r;return(0,m.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e){t.next=2;break}return t.abrupt("return",new Promise((function(t){return t([])})));case 2:return t.next=4,fetch("https://geodata.gov.hk/gs/api/v1.0.0/locationSearch?q=".concat(encodeURI(e)),n).then((function(t){return t.json()}));case 4:return r=t.sent,t.abrupt("return",r.map((function(t){var e=(0,j.Z)("+proj=tmerc +lat_0=22.31213333333334 +lon_0=114.1785555555556 +k=1 +x_0=836694.05 +y_0=819069.8 +ellps=intl +towgs84=-162.619,-276.959,-161.764,0.067753,-2.24365,-1.15883,-1.09425 +units=m +no_defs","+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs",[t.x,t.y]),n=(0,o.Z)(e,2),r=n[0],a=n[1];return{address:{zh:t.addressZH,en:t.addressEN},name:{zh:t.nameZH,en:t.nameEN},lat:a,lng:r}})));case 6:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}(),C=function(t){var e=t.placeholder,n=void 0===e?"":e,r=t.onChange,a=t.stopList,o=t.value,c=(0,g.$)(),s=c.t,u=c.i18n,l=(0,i.useRef)(new AbortController),d=(0,i.useRef)(v()((function(t,e){var n=Object.values(a).filter((function(e){return e.name.zh.includes(t)||e.name.en.toLowerCase().includes(t.toLowerCase())})).map((function(t){return{label:"".concat(t.name[u.language]," - ").concat(s("\u8eca\u7ad9")),location:t.location}})).slice(0,10);l.current.abort(),l.current=new AbortController,w(t,{signal:l.current.signal}).then((function(t){e(n.concat(t.map((function(t){var e=t.name,n=t.address,r=t.lat,a=t.lng;return{label:[e[u.language],n[u.language]].filter((function(t){return t})).join(" - "),location:{lat:r,lng:a}}}))))}))}),200)).current;return(0,Z.jsx)(I,{isClearable:!0,value:o,loadOptions:d,placeholder:n,onChange:r,classNamePrefix:"react-select"})},I=(0,k.ZP)(b.Z)((function(t){var e=t.theme;return{".react-select__control":{background:"".concat("dark"===e.palette.mode?e.palette.background.default:"white"," !important"),border:"none !important",borderRadius:"unset !important",borderBottom:"1px hsl(0, 0%, 80%) solid !important"},".react-select__input":{color:"".concat("dark"===e.palette.mode?e.palette.primary.main:e.palette.text.primary," !important")},".react-select__valueContainer":{color:"".concat("dark"===e.palette.mode?e.palette.primary.main:e.palette.text.primary," !important")},".react-select__single-value":{color:"".concat("dark"===e.palette.mode?e.palette.primary.main:e.palette.text.primary," !important")},".react-select__option:hover":{filter:"grayscale(1) !important"},".react-select__option--is-focused":{background:"".concat("dark"===e.palette.mode?e.palette.background.default:"white"," !important")},".react-select__option--is-selected":{background:"".concat("dark"===e.palette.mode?e.palette.background.default:"white"," !important"),color:"".concat("dark"===e.palette.mode?e.palette.primary.main:e.palette.text.primary," !important")},".react-select__menu":{background:"".concat("dark"===e.palette.mode?e.palette.background.default:"white"," !important"),color:"".concat("dark"===e.palette.mode?e.palette.primary.main:e.palette.text.primary," !important")},".react-select__meauList":{background:"".concat("dark"===e.palette.mode?e.palette.background.default:"white"," !important"),color:"".concat("dark"===e.palette.mode?e.palette.primary.main:e.palette.text.primary," !important")}}})),y=n(4942),_=n(3171),L=n(8492),S=n(3213),R=n(1872),O=n(9530),F=n(3310),M=function(t){var e=t.routes,n=t.idx,r=t.handleRouteClick,a=t.expanded,o=t.stopIdx,c=(0,i.useContext)(p.Z).db,s=c.routeList,u=c.stopList,d=(0,g.$)(),f=d.t,m=d.i18n;return(0,Z.jsxs)(_.Z,{TransitionProps:{unmountOnExit:!0},sx:N,onChange:function(){return r(n)},expanded:a,children:[(0,Z.jsx)(L.Z,{sx:T,children:(0,Z.jsx)(S.Z,{primary:e.map((function(t,e){var r=t.routeId,a=s[r],o=a.route,c=a.serviceType;return(0,Z.jsxs)("span",{children:[(0,Z.jsx)(O.Z,{routeNo:o}),parseInt(c,10)>=2&&(0,Z.jsx)(l.Z,{variant:"caption",children:f("\u7279\u5225\u73ed")})]},"search-".concat(n,"-").concat(e))})),secondary:function(t){var e=[];t.forEach((function(t){var n=t.routeId,r=t.on,a=s[n],o=a.fares,c=a.stops;e.push(u[Object.values(c).sort((function(t,e){return e.length-t.length}))[0][r]].name[m.language]+(o?" ($".concat(o[r],")"):""))}));var n=t[t.length-1],r=n.routeId,a=n.off,o=s[r].stops;return e.concat(u[Object.values(o).sort((function(t,e){return e.length-t.length}))[0][a]].name[m.language]).join(" \u2192 ")}(e),sx:z})}),(0,Z.jsx)(R.Z,{sx:E,children:e.map((function(t,e){return(0,Z.jsx)(F.Z,{routeId:t.routeId.toUpperCase(),seq:t.on+(o?o[e]:0),containerSx:P,showStopName:!0},"timereport-".concat(n,"-").concat(e))}))})]})},N={border:"1px solid rgba(0, 0, 0, .125)",boxShadow:"none","&:not(:last-child)":{borderBottom:0},"&:before":{display:"none"},"&.Mui-expanded":{margin:"auto"}},T={backgroundColor:function(t){return"dark"===t.palette.mode?t.palette.background.default:"rgba(0, 0, 0, .03)"},borderBottom:"1px solid rgba(0, 0, 0, .125)",marginBottom:-1,minHeight:44,"&.Mui-expanded":{minHeight:44},"& .MuiAccordionSummary-content":(0,y.Z)({margin:"8px 0",flexDirection:"column"},"&.Mui-expanded",{margin:"8px 0"})},E={px:function(t){return t.spacing(2)},py:function(t){return t.spacing(1)},display:"flex"},P={width:"50%"},z={"& .MuiListItemText-primary > span":{width:"50%",display:"inline-block","& > span":{fontSize:"0.6rem",marginLeft:"8px"}}},A=n(4536),B=n(5594),$=n(9062),D=n(8817),q=n(4580),H=n(8153),W=n(7248),U=n.n(W),G=n(7308),J=n(5823),Y=function(t){var e=t.center,n=t.start,r=t.end,a=(0,A.Sx)();return e?a.flyTo((0,J.bf)(e)):r&&a.fitBounds(U().latLngBounds(U().latLng(n.lat,n.lng),U().latLng(r.lat,r.lng))),(0,Z.jsx)(Z.Fragment,{})},K=function(){var t=(0,i.useContext)(p.Z),e=t.geolocation;return"granted"!==t.geoPermission?null:(0,Z.jsx)(B.C,{center:(0,J.bf)(e),radius:25})},Q=function(t){var e=t.start;return e?(0,Z.jsx)($.J,{position:e,icon:ot({isStart:!0})}):null},V=function(t){var e=t.end;return e?(0,Z.jsx)($.J,{position:e,icon:ot({isStart:!1})}):null},X=function(t){var e=t.onClick;return(0,Z.jsx)("div",{className:"leaflet-bottom leaflet-right",children:(0,Z.jsx)(u.Z,{sx:ut,className:"leaflet-control leaflet-bar",onClick:e,children:(0,Z.jsx)(G.Z,{className:it.centralControl})})})},tt=function(t){var e=t.route,n=e.routeId,r=e.on,a=e.off,o=t.lv,c=t.stopIdx,s=t.onMarkerClick,u=(0,i.useContext)(p.Z).db,l=u.routeList,d=u.stopList,f=(0,g.$)().i18n,m=Object.values(l[n].stops).sort((function(t,e){return e.length-t.length}))[0].slice(r,a+1),x=n.split("-")[0];return(0,Z.jsxs)(Z.Fragment,{children:[m.map((function(t,e){return(0,Z.jsx)($.J,{position:d[t].location,icon:at({active:c===e,passed:e<c,lv:o}),alt:"".concat(e,". ").concat(x," - ").concat(d[t].name[f.language]),eventHandlers:{click:function(t){s(n,e)}}},"".concat(t,"-").concat(e))})),m.slice(1).map((function(t,e){return(0,Z.jsx)(D.a,{positions:[rt(d[m[e]].location),rt(d[t].location)],color:0===o?"#FF9090":"#d0b708"},"".concat(t,"-line"))}))]})},et=function(t){var e=t.routes,n=t.start,r=t.end,a=(0,i.useContext)(p.Z).db,o=a.routeList,c=a.stopList,s=[],u=[];if(!n||!r)return(0,Z.jsx)(Z.Fragment,{});u.push(n),(e||[]).forEach((function(t){var e=t.routeId,n=t.on,r=t.off,a=Object.values(o[e].stops).sort((function(t,e){return e.length-t.length}))[0];u.push(c[a[n]].location),u.push(c[a[r]].location)})),u.push(r||n);for(var l=0;l<u.length/2;++l)s.push([u[2*l],u[2*l+1]]);return(0,Z.jsx)(Z.Fragment,{children:s.map((function(t,e){return(0,Z.jsx)(D.a,{positions:[rt(t[0]),rt(t[1])],color:"green"},"line-".concat(e))}))})},nt=function(t){var e=t.routes,n=t.start,r=t.end,a=t.stopIdx,c=t.onMarkerClick,s=(0,i.useContext)(p.Z),l=s.geolocation,d=s.geoPermission,f=s.updateGeoPermission,g=s.colorMode,m=(0,i.useState)({center:null,isFollow:!1}),x=(0,o.Z)(m,2),h=x[0],v=x[1],b=h.center,k=h.isFollow,j=(0,i.useState)(null),w=(0,o.Z)(j,2),C=w[0],I=w[1],y=(0,i.useCallback)((function(t){var e=null!==t&&void 0!==t?t:{},n=e.center,r=e.isFollow;v({center:n||(null===C||void 0===C?void 0:C.getCenter()),isFollow:r||!1})}),[v]);return(0,i.useEffect)((function(){if(C){var t=function(){y({center:C.getCenter()})};return C.on({dragend:t}),function(){C.off({dragend:t})}}}),[C,y]),(0,i.useEffect)((function(){k&&(b&&l.lat===b.lat&&l.lng===b.lng||y({center:l,isFollow:!0}))}),[l,b,k,y]),(0,Z.jsx)(u.Z,{sx:st,children:(0,Z.jsxs)(q.h,{center:b||(n&&r?{lat:(n.lat+r.lat)/2,lng:(n.lng+r.lng)/2}:(0,J.bf)(n)),zoom:16,scrollWheelZoom:!1,className:it.mapContainer,ref:I,children:[(0,Z.jsx)(Y,{center:b,start:(0,J.bf)(n),end:r}),(0,Z.jsx)(H.I,{attribution:'\xa9 <a href="http://osm.org/copyright">OpenStreetMap</a> contributors \xa9 <a href="https://carto.com/attributions">CARTO</a>',url:"dark"===g?"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png"}),(e||[]).map((function(t,e){return(0,Z.jsx)(tt,{route:t,lv:e,stopIdx:a[e],onMarkerClick:c},"route-".concat(e))})),(0,Z.jsx)(et,{routes:e,start:n,end:r}),(0,Z.jsx)(K,{}),(0,Z.jsx)(Q,{start:n}),(0,Z.jsx)(V,{end:r}),(0,Z.jsx)(X,{onClick:function(){"granted"===d?y({isFollow:!0}):"denied"!==d&&(y({isFollow:!0}),f("opening"))}})]})})},rt=function(t){return[t.lat,t.lng]},at=function(t){var e=t.active,n=t.passed,r=t.lv;return U().icon({iconUrl:"https://unpkg.com/leaflet@1.0.1/dist/images/marker-icon-2x.png",className:"".concat(it.marker," ").concat(e?it.active:""," ").concat(n?it.passed:""," lv-").concat(r)})},ot=function(t){var e=t.isStart;return U().icon({iconUrl:"https://unpkg.com/leaflet@1.0.1/dist/images/marker-icon-2x.png",className:"".concat(it.marker," ").concat(e?"start":"end")})},ct="searchMap",it={mapContainer:"".concat(ct,"-mapContainer"),centralControl:"".concat(ct,"-centralControl"),marker:"".concat(ct,"-marker"),active:"".concat(ct,"-active"),passed:"".concat(ct,"-passed")},st=(r={height:"30vh",filter:function(t){return"dark"===t.palette.mode?"brightness(0.8)":"none"}},(0,y.Z)(r,"& .".concat(it.mapContainer),{height:"30vh"}),(0,y.Z)(r,"& .".concat(it.marker),{marginLeft:"-12px",marginTop:"-41px",width:"25px",height:"41px",zIndex:618,outline:"none",filter:"hue-rotate(130deg)","&.lv-1":{filter:"hue-rotate(210deg) brightness(1.5)"},"&.start":{filter:"hue-rotate(30deg)"},"&.end":{filter:"hue-rotate(280deg)"}}),(0,y.Z)(r,"& .".concat(it.active),{animation:"blinker 2s linear infinite"}),(0,y.Z)(r,"& .".concat(it.passed),{filter:"grayscale(100%)"}),r),ut=(0,y.Z)({background:"white",height:"28px",marginBottom:"20px !important",marginRight:"5px !important"},"& .".concat(it.centralControl),{padding:"5px",color:"black"}),lt=n(7420),dt=n(421),pt=function(){var t=(0,g.$)().t;return(0,Z.jsxs)(u.Z,{sx:vt,children:[(0,Z.jsx)(l.Z,{variant:"h5",children:t("Route Search header")}),(0,Z.jsx)(d.Z,{}),(0,Z.jsx)(l.Z,{variant:"subtitle1",children:t("Route Search description")}),(0,Z.jsx)("br",{}),(0,Z.jsx)(l.Z,{variant:"body2",children:t("Route Search constraint")}),(0,Z.jsxs)(l.Z,{variant:"body2",children:["1. ",t("Route Search caption 1")]}),(0,Z.jsxs)(l.Z,{variant:"body2",children:["2. ",t("Route Search caption 2")]}),(0,Z.jsxs)(l.Z,{variant:"body2",children:["3. ",t("Route Search caption 3")]})]})},ft=function(){var t=(0,g.$)(),e=t.t,n=t.i18n,r=(0,i.useContext)(p.Z),l=r.AppTitle,d=r.geolocation,m=r.energyMode,x=r.db,h=x.routeList,v=x.stopList,b=r.vibrateDuration,k=(0,i.useContext)(f.Z),j=k.locations,w=k.setLocations,I=k.status,y=k.setStatus,_=k.result,L=k.setResult,S=k.resultIdx,R=k.setResultIdx,O=(0,i.useRef)(void 0),F=function(){O.current&&(O.current.terminate(),O.current=void 0)};(0,i.useEffect)((function(){(0,J.ND)({title:e("\u9ede\u5c0d\u9ede\u8def\u7dda\u641c\u5c0b")+" - "+e(l),description:e("route-search-page-description"),lang:n.language})}),[n.language]),(0,i.useEffect)((function(){"rendering"===I&&y("ready")}),[_]),(0,i.useEffect)((function(){return"waiting"===I&&j.end&&window.Worker&&(F(),O.current=new Worker("/search-worker.js"),O.current.postMessage({routeList:h,stopList:v,start:j.start?j.start.location:d,end:j.end.location,maxDepth:2}),O.current.onmessage=function(t){if("done"===t.data.type)return F(),void y(t.data.count?"rendering":"ready");!function(t){var e=t.reduce((function(t,e){return t.concat.apply(t,(0,c.Z)(e.map((function(t){return["".concat(t.routeId,"/").concat(t.on),"".concat(t.routeId,"/").concat(t.off)]}))))}),[]).filter((function(t,e,n){return n.indexOf(t)===e}));Promise.all(e.map((function(t){var e=t.split("/"),r=(0,o.Z)(e,2),c=r[0],i=r[1];return navigator.onLine?(0,lt.fetchEtas)((0,a.Z)((0,a.Z)({},h[c]),{},{seq:parseInt(i,10),routeStops:h[c].stops,co:Object.keys(h[c].stops),language:n.language})):new Promise((function(t){return t([])}))}))).then((function(t){return e.filter((function(e,n){return!navigator.onLine||t[n].length&&t[n].reduce((function(t,e){return t||e.eta}),null)}))})).then((function(e){L((function(n){return[].concat((0,c.Z)(n),(0,c.Z)(t.filter((function(t){return t.reduce((function(t,n){return t&&(-1!==e.indexOf("".concat(n.routeId,"/").concat(n.on))||-1!==e.indexOf("".concat(n.routeId,"/").concat(n.off)))}),!0)})).map((function(t){var e=j.start?j.start.location:d;return t.map((function(t,n){for(var r=Object.values(h[t.routeId].stops).sort((function(t,e){return e.length-t.length}))[0],o=-1,c=1e5,i=t.on;i<t.off;++i){var s=(0,J.Sp)(v[r[i]].location,e);s<c&&(o=i,c=s)}return e=v[r[t.off]].location,(0,a.Z)((0,a.Z)({},t),{},{on:o})}))})).map((function(t){return[t,t.reduce((function(t,e){return t+e.off-e.on}),0)]})).sort((function(t,e){return t[1]-e[1]})).map((function(t){return t[0]}))))}))}))}(t.data.value.sort((function(t,e){return t.length-e.length})))}),function(){F()}}),[I,j]);var N=function(t){(0,J.tp)(b),setTimeout((function(){R({resultIdx:t,stopIdx:[0,0]})}),0)};return(0,Z.jsxs)(s.Z,{sx:gt,square:!0,elevation:0,children:[m?null:(0,Z.jsx)(nt,{start:j.start?j.start.location:d,end:j.end?j.end.location:null,routes:_[S.resultIdx],stopIdx:S.stopIdx,onMarkerClick:function(t,e){var n=_[S.resultIdx].map((function(t){return t.routeId})).indexOf(t);R((function(t){var r=(0,c.Z)(t.stopIdx);return r[n]=e,(0,a.Z)((0,a.Z)({},t),{},{stopIdx:r})}))}}),(0,Z.jsxs)(u.Z,{sx:mt,children:[(0,Z.jsx)(C,{value:j.start,placeholder:e("\u4f60\u7684\u4f4d\u7f6e"),onChange:function(t){w((0,a.Z)((0,a.Z)({},j),{},{start:t})),y("waiting"),R({resultIdx:0,stopIdx:[0,0]}),L([])},stopList:v}),(0,Z.jsx)(C,{value:j.end,placeholder:e("\u76ee\u7684\u5730"),onChange:function(t){w((0,a.Z)((0,a.Z)({},j),{},{end:t})),t&&y("waiting"),R({resultIdx:0,stopIdx:[0,0]}),L([])},stopList:v})]}),(0,Z.jsx)(u.Z,{sx:m?ht:xt,children:j.end?"waiting|rendering".includes(I)&&0===_.length?(0,Z.jsx)(dt.u,{}):"ready|waiting|rendering".includes(I)&&_.length?_.map((function(t,e){return(0,Z.jsx)(M,{routes:t,idx:e,handleRouteClick:N,expanded:e===S.resultIdx,stopIdx:e===S.resultIdx?S.stopIdx:null},"search-result-".concat(e))})):(0,Z.jsx)(Z.Fragment,{children:e("\u627e\u4e0d\u5230\u5408\u9069\u7684\u5df4\u58eb\u8def\u7dda")}):(0,Z.jsx)(pt,{})})]})},gt={background:function(t){return"dark"===t.palette.mode?t.palette.background.default:"white"},overflowY:"hidden",textAlign:"left",width:"100%"},mt={marginTop:"2%",padding:"0% 2%"},xt={overflowY:"scroll",height:"calc(100% - 30vh - 76px)"},ht={overflowY:"scroll",height:"calc(100% - 76px)"},vt={textAlign:"left",marginTop:"5%",padding:"5%"}}}]);